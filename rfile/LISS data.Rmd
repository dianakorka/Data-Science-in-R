---
title: "LISS data, LISS Core Study, the Politics and Values Section"
output: github_document
author: Diana Korka
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Code for preparing LISS panel data for an analysis of propensity to vote and political views

## Reading and cleaning the data

Loading the necessary packages.

```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(visdat)
library(tidyr)
library(tibble)
library(ggthemes)
library(haven)
library(stringr)
```


With the code below we read panel data year by year, starting with 2023 and until 2019 and keep only the variables of interest: propensity to vote and political orientation. The data cleaning for the set of covariates is done separately as data comes from a different file.

We also keep age, as this is included in the Politics and Values Section and may be useful as a covariate.

We start with the 2023 panel data and then apply the same transformations to the 2022-2019 data.


### Data transformation step by step for 2023 panel data


```{r message=FALSE, warning=FALSE}
data23 <- read_delim("~/Documents/Amsterdam/rfile/cv23o_EN_1.0p.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
```

Checking how many rows and columns there are in the original dataset.


```{r}
dim(data23)
```


Keep only the few variables of interest:

nomem_encr	Number of household member encrypted

cv23o_m1	Year and month of the field work period - part 3

cv23o160	Preloaded variable: age â€“ part 2	

cv23o243	If parliamentary elections were held today, what is the percent chance that you will vote?

cv23o101	Where would you place yourself on the scale below, where 0 means left and 10 means right? Since there are 10 answer possibilities, we will recode this as LEFT=0 for values from 0 to 5 (including), and RIGHT=1 for values from 6 to 10. 



```{r}
data23_cleaned <- data23 %>% 
  select(nomem_encr, cv23o_m3, cv23o160, cv23o243, cv23o101)
```

Below some descriptive statistics of the 2023 panel data, the variables of interest.

Notice that some observations encoded with -9 are impossible and for the propensity to vote there are 525 missing values. Similarly for political orientation there are 421 missing values. 

We have no choice but to drop these from our sample.


```{r}
data23_cleaned %>% 
  summary()
```

We notice some data entry points are erroneous: -9 min value for several variables. And there are missing values as well for propensity to vote and for political orientation (right-left).

Since we cannot impute data from another source on propensity to vote or political orientation, we need to remve the rows where either one of these variables has missing data.

Below are the rows that will be dropped conditional of missing data for either voting propensity or political orientation. A total of 545 samples.


```{r}
data23_cleaned %>% 
  filter(is.na(cv23o101) | is.na(cv23o243)) %>% 
  dim()
```

Dropping the missing values.


```{r}
data23_cleaned <-data23_cleaned %>% 
  drop_na(cv23o101, cv23o243)
```


The next data cleaning step is to remove values below 0 for voting propensity and political orientation as these are not possible and must be erroneous data. With the code below we see that we loose another 753 observations. This data cannot be inferred from other alternative information and has to be dropped as well.


```{r}
data23_cleaned %>% 
  filter(cv23o243<0 | cv23o101<0) %>% 
  dim()
```


```{r}
data23_cleaned <- data23_cleaned %>% 
  filter(cv23o243>0 & cv23o101>0)
```


Now our descriptive statistics look as show below:


```{r}
data23_cleaned <- data23_cleaned %>% 
  select(nomem_encr, cv23o160, cv23o243, cv23o101) %>% 
  mutate(survey_year=2023) %>% 
  dplyr:: rename(age=cv23o160, propensity_to_vote=cv23o243, political_orientation=cv23o101)


data23_cleaned %>% 
  summary()
```

### Visualizing the data distributions

And a quick visualisation of our data before recoding.

```{r}
data23_cleaned %>% 
  ggplot(aes(x=political_orientation, y=propensity_to_vote)) +
  geom_point()
```


Also check how our variables are distributed.

Below is the distribution of political orientation.

```{r}
data23_cleaned %>% 
  ggplot(aes(political_orientation)) +
  geom_histogram(stat="count", fill="cornflowerblue")+
  scale_x_continuous(breaks=1:10, labels=1:10)+
  geom_vline(xintercept=5.5)+
  labs(title = "Histogram of political orientation in 2023",
       caption="LISS2023 panel data")
```


Propensity to vote is highly skewed, with many values around 100.


```{r}
bins=round(sqrt(nrow(data23_cleaned)))

data23_cleaned %>% 
  ggplot(aes(propensity_to_vote)) +
  geom_histogram(aes(y=after_stat(density)), bins = bins, fill="cornflowerblue") +
  geom_density()+
  labs(title = "Histogram of propensity to vote in 2023",
       caption="LISS2023 panel data")
```


```{r}
data23_cleaned %>% 
  ggplot(aes(x="", y=propensity_to_vote)) +
  geom_boxplot(fill="cornflowerblue")+
  coord_flip()+
  geom_point(size=1, alpha=0.3)+
  labs(title = "Boxplot propensity to vote in 2023",
       caption="LISS2023 panel data")
```


### Recoding political values

Below we recode the political orientation data such that LEFT=0 for values from 0 to 5 (including), and RIGHT=1 for values from 6 to 10 --> into a new variable called **right**.


```{r}
data23_cleaned <- data23_cleaned %>% 
  mutate(right=case_when(political_orientation<=5 ~ 0, TRUE ~ 1)) %>% 
  mutate(right=as.factor(right))
  
  
```


Check how propensity to vote varies by the newly created **right** variable.


```{r}
data23_cleaned %>% 
  ggplot(aes(x=right, y=propensity_to_vote))+
  geom_boxplot(fill="cornflowerblue")+
  coord_flip()+
  geom_point(size=1, alpha=0.3)+
  labs(title = "Boxplot propensity to vote by political orientation in 2023",
       subtitle = "1=right-leaning, 0=left-leaning",
       x="",
       caption="LISS2023 panel data")
```


```{r}
data23_cleaned %>% 
  ggplot(aes(propensity_to_vote)) +
  geom_histogram(aes(y=after_stat(density)),
                 bins=bins, fill="cornflowerblue") +
  geom_density() +
  facet_wrap(vars(right))+
  labs(title="Propensity to vote distribution by political orientation",
       subtitle="0=left, 1=right",
       caption="LISS 2023 panel data")

```


Descriptive statistics

```{r}
data23_cleaned %>% 
  group_by(right) %>% 
  dplyr:: summarise(counts=n(),
            mean_political_orientation = mean(political_orientation),
            median_political_orientation=median(political_orientation),
            sd_political_orientation=sd(political_orientation),
            mean_propensity_to_vote= mean(propensity_to_vote),
            median_propensity_to_vote= median(propensity_to_vote),
            sd_propensity_to_vote=sd(propensity_to_vote)) %>% 
  t()
```

Right-leaning voters are slightly more moderate in political orientation (7 vs 4) and have sightly lower variance in this variable. They also have slightly higher propensity to vote and slightly lower variance in it.


Quick check on one covariate: How does political orientation vary by age?


```{r}
data23_cleaned %>% 
  ggplot(aes(x=right, y=age))+
  geom_boxplot(fill="cornflowerblue")+
  coord_flip()+
  geom_point(size=1, alpha=0.3)+
  labs(title = "Boxplot age by political orientation in 2023",
       subtitle = "1=right-leaning, 0=left-leaning",
       x="",
       caption="LISS2023 panel data")
```

And descriptive statistics: we have similar mean, median age and standard deviation of age across the two groups: left and right-leaning individuals.

```{r}
data23_cleaned %>% 
  group_by(right) %>% 
  dplyr:: summarise(mean_age = mean(age),
            median_age=median(age),
            sd_age=sd(age)) %>% 
  t()
```



### Reading and transforming 2022 data below


```{r message=FALSE, warning=FALSE}
data22 <- read_delim("~/Documents/Amsterdam/rfile/cv22n_EN_1.0p.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
```




```{r}
data22_cleaned <- data22 %>% 
  select(nomem_encr, cv22n160, cv22n243, cv22n101) %>% 
  drop_na(cv22n101, cv22n243) %>% 
  filter(cv22n243>0 & cv22n101>0) %>% 
  mutate(survey_year=2022) %>% 
  dplyr:: rename(age=cv22n160, propensity_to_vote=cv22n243, political_orientation=cv22n101) %>% 
  mutate(right=case_when(political_orientation<=5 ~ 0, TRUE ~ 1)) %>% 
  mutate(right=as.factor(right))
```


### Descriptive statistics and visualisations for the 2022 data


```{r}
data22_cleaned %>% 
  summary()
```

Quickly checking if the same rough distribution holds in 2022


```{r}
data22_cleaned %>% 
  ggplot(aes(x=right, y=propensity_to_vote))+
  geom_boxplot(fill="cornflowerblue")+
  coord_flip()+
  geom_point(size=1, alpha=0.3)+
  labs(title = "Boxplot propensity to vote by political orientation in 2022",
       subtitle = "1=right-leaning, 0=left-leaning",
       x="",
       caption="LISS2022 panel data")
```


```{r}
data22_cleaned %>% 
  group_by(right) %>% 
  dplyr:: summarise(mean_political_orientation = mean(political_orientation),
            median_political_orientation=median(political_orientation),
            sd_political_orientation=sd(political_orientation),
            mean_propensity_to_vote= mean(propensity_to_vote),
            median_propensity_to_vote= median(propensity_to_vote),
            sd_propensity_to_vote=sd(propensity_to_vote)) %>% 
  t()
```

```{r}
data22_cleaned %>% 
  ggplot(aes(x=right, y=age))+
  geom_boxplot(fill="cornflowerblue")+
  coord_flip()+
  geom_point(size=1, alpha=0.3)+
  labs(title = "Boxplot age by political orientation in 2022",
       subtitle = "1=right-leaning, 0=left-leaning",
       x="",
       caption="LISS2022 panel data")
```

```{r}
data22_cleaned %>% 
  group_by(right) %>% 
  dplyr:: summarise(mean_age = mean(age),
            median_age=median(age),
            sd_age=sd(age)) %>% 
  t()
```


## Joining together 2022 and 2023 data

We join the data by the encrypted number of household (which is a unique number in each dataset).
We remove samples with missing data on propensity to vote and political orientation.
We obtain 3361 samples.


```{r}
data22_cleaned %>% 
  inner_join(data23_cleaned, by=c("nomem_encr"), suffix=c(".22", ".23")) %>% 
  dim()
``` 


How many respondents have changed their political orientation from 2022 to 2023: 447.


```{r}
data22_cleaned %>% 
  left_join(data23_cleaned, by=c("nomem_encr"), suffix=c(".22", ".23")) %>% 
  drop_na(propensity_to_vote.23, political_orientation.23) %>% 
  filter(right.22!=right.23) %>% 
  dim()
 
```


228 swinged from left to right and 219 from right to left.


```{r}
data22_cleaned %>% 
  left_join(data23_cleaned, by=c("nomem_encr"), suffix=c(".22", ".23")) %>% 
  drop_na(propensity_to_vote.23, political_orientation.23) %>% 
  filter(right.22!=right.23) %>% 
  group_by(right.22, right.23) %>% 
  dplyr:: summarise(number=n())
```


We need to discard respondents who swinged for the purpose of our analysis.
So we are left with 2914 respondents.

```{r}
data22_23 <- data22_cleaned %>% 
  inner_join(data23_cleaned, by=c("nomem_encr"), suffix=c(".22", ".23")) %>% 
  filter(right.22==right.23)
```


```{r}
dim(data22_23)
```


Descriptive statistics for the joined data for 2 years only


```{r}

data22_23 %>% 
  group_by(right.22) %>% 
  summarise(mean_prop_vote_22= mean(propensity_to_vote.22),
            sd_prop_vote_22=sd(propensity_to_vote.22),
            mean_prop_vote_23=mean(propensity_to_vote.23),
            sd_prop_vote_23=sd(propensity_to_vote.23))
```


### Reading data and applying the same transformations to the 2019, 2020 and 2021 panels


```{r}
data21 <- read_dta("cv21m_EN_1.0p.dta")
data20 <- read_dta("cv20l_EN_1.0p.dta")
data19 <- read_dta("cv19k_EN_1.0p.dta")
```



```{r}
data21_cleaned <- data21 %>% 
  select(nomem_encr, cv21m160, cv21m243, cv21m101) %>% 
  drop_na(cv21m101, cv21m243) %>% 
  filter(cv21m243>0 & cv21m101>0) %>% 
  mutate(survey_year.21=2021) %>% 
  dplyr:: rename(age.21=cv21m160, propensity_to_vote.21=cv21m243, political_orientation.21=cv21m101) %>% 
  mutate(right.21=case_when(political_orientation.21<=5 ~ 0, TRUE ~ 1)) %>% 
  mutate(right.21=as.factor(right.21))
```


```{r}
data20_cleaned <- data20 %>% 
  select(nomem_encr, cv20l160, cv20l243, cv20l101) %>% 
  drop_na(cv20l101, cv20l243) %>% 
  filter(cv20l243>0 & cv20l101>0) %>% 
  mutate(survey_year.20=2020) %>% 
  dplyr::rename(age.20=cv20l160, propensity_to_vote.20=cv20l243, political_orientation.20=cv20l101) %>% 
  mutate(right.20=case_when(political_orientation.20<=5 ~ 0, TRUE ~ 1)) %>% 
  mutate(right.20=as.factor(right.20))
```


```{r}
data19_cleaned <- data19 %>% 
  select(nomem_encr, cv19k160, cv19k243, cv19k101) %>% 
  drop_na(cv19k101, cv19k243) %>% 
  filter(cv19k243>0 & cv19k101>0) %>% 
  mutate(survey_year.19=2019) %>% 
  dplyr::rename(age.19=cv19k160, propensity_to_vote.19=cv19k243, political_orientation.19=cv19k101) %>% 
  mutate(right.19=case_when(political_orientation.19<=5 ~ 0, TRUE ~ 1)) %>% 
  mutate(right.19=as.factor(right.19))
```




### Joining together datasets for all 5 years


```{r}
library(plyr)

panel_19_23 <- join_all(list(data19_cleaned, data20_cleaned, data21_cleaned, data22_23), 
         by='nomem_encr', type='inner') 
```


```{r}
nrow(panel_19_23)
```


In the 2019 data there is an error in the reported propensity to vote data 999, which is not contained in the 0-100 scale. Same situation for political_orientation. 


```{r}
panel_19_23 %>% 
  filter(propensity_to_vote.19==999)
```

We see that for these people political orientation was 100 over all the following 4 years, so we use the 2020 value.


```{r}
panel_19_23 <- panel_19_23 %>% 
  mutate(propensity_to_vote.19=if_else(propensity_to_vote.19==999, true=propensity_to_vote.20, false=propensity_to_vote.19)) 
```


And now checking for 999 values in political orientation: there are 47 observations for which this was encoded as 999. Not to loose any further data, for these 47 people we will use the political orientation score reported in 2020. If over the following years they swing from left to right, they will be dropped from the analysis.


```{r}
panel_19_23 %>% 
  filter(political_orientation.19==999) %>% 
  dim()
```


```{r}
panel_19_23 <- panel_19_23 %>% 
  mutate(political_orientation.19=if_else(political_orientation.19==999, 
                                          true=political_orientation.20, false=political_orientation.19),
         right.19=case_when(political_orientation.19<=5 ~ 0, TRUE ~ 1)) %>% 
  mutate(right.19=as.factor(right.19))
```



```{r}
panel_19_23 %>% 
  dim()
```


We try to filter out anyone who swinged left-right and vice-versa over the entire period.
And we are left with 1658 observations.


```{r}
panel_19_23 %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) %>% 
  dim()
```


Descriptive statistics for the panel data.


```{r}
panel_19_23 %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) %>% 
  group_by(right.20) %>% 
  dplyr:: summarise(mean_prop_vote_19= mean(propensity_to_vote.19),
                    mean_prop_vote_20= mean(propensity_to_vote.20),
            mean_prop_vote_21=mean(propensity_to_vote.21),
            mean_prop_vote_22= mean(propensity_to_vote.22),
            mean_prop_vote_23=mean(propensity_to_vote.23),
            sd_prop_vote_19=sd(propensity_to_vote.19),
            sd_prop_vote_20=sd(propensity_to_vote.20),
            sd_prop_vote_21=sd(propensity_to_vote.21),
            sd_prop_vote_22=sd(propensity_to_vote.22),
            sd_prop_vote_23=sd(propensity_to_vote.23)) %>% 
  ungroup()
```


Below plotting the summary data from above in a line chart.



```{r}

panel_19_23 %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) %>% 
  group_by(right.20) %>% 
  dplyr:: summarise(m2019= mean(propensity_to_vote.19),
                    m2020= mean(propensity_to_vote.20),
            m2021=mean(propensity_to_vote.21),
            m2022= mean(propensity_to_vote.22),
            m2023=mean(propensity_to_vote.23)) %>% 
  ungroup() %>% 
  pivot_longer(cols=c(-right.20),
               names_to="year",
               values_to="mean") %>% 
  mutate(year=str_remove(year, "m")) %>% 
  mutate(year=as.numeric(year)) %>% 
  ggplot(aes(x=year, y=mean, color=right.20))+
  geom_point()+
  geom_line()+
  labs(title="Mean propensity to vote by political orientation",
       subtitle = "1=right-leaning, 0=left-leaning, no swing",
       caption="LISS Panel data 2019-2023: 1658 observations")

```

Frequency counts by control and treatment group: in our 2019-2023 panel, 792 respondents were left-leaning and 866 were right-leaning.


```{r}
panel_19_23 %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) %>% 
  group_by(right.20) %>% 
  dplyr:: summarise(count=n()) %>% 
  ungroup()
```


### Visualizing the data


Transforming the data into a longer tibble for visualisation (yearly data stacked).

```{r message=FALSE, warning=FALSE}
panel19_23_stacked <- panel_19_23 %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19)  %>% 
    mutate(right.19=as.numeric(right.19),
         right.20=as.numeric(right.20),
         right.21=as.numeric(right.21),
         right.22=as.numeric(right.22),
         right.23=as.numeric(right.23))%>% 
  pivot_longer(col=c(-nomem_encr), names_to="metrics", values_to = "values") %>% 
  mutate(year=str_sub(metrics, start=-2),
         metrics=str_remove(metrics, ".\\d\\d")) %>% 
  pivot_wider(names_from = metrics, values_from = values) %>% 
  select(-year) %>% 
  mutate(right=if_else(right==1, true=0, false=1)) %>% 
  mutate(right=as.factor(right))

```



And checking distributions.


```{r}
panel19_23_stacked %>% 
  ggplot(aes(x=right, y=propensity_to_vote))+
  geom_boxplot(fill="cornflowerblue")+
  coord_flip()+
  geom_point(size=1, alpha=0.3)+
  labs(title = "Boxplot propensity to vote by political orientation for 2019-2023",
       subtitle = "1=right-leaning, 0=left-leaning",
       x="",
       caption="LISS2019-2023 panel data")
```

And descriptive statistics

```{r}
panel19_23_stacked %>% 
  group_by(right) %>% 
  dplyr:: summarise(counts=n(),
            mean_political_orientation = mean(political_orientation),
            median_political_orientation=median(political_orientation),
            sd_political_orientation=sd(political_orientation),
            mean_propensity_to_vote= mean(propensity_to_vote),
            median_propensity_to_vote= median(propensity_to_vote),
            sd_propensity_to_vote=sd(propensity_to_vote)) %>% 
  t()
```

And by age: left-leaning voters are a bit older.


```{r}
panel19_23_stacked %>% 
  group_by(right) %>% 
  dplyr:: summarise(mean_age = mean(age),
            median_age=median(age),
            sd_age=sd(age)) %>% 
  t()
```

```{r}
panel19_23_stacked %>% 
  group_by(right, survey_year) %>% 
  dplyr:: summarise(mean_age = mean(age),
            median_age=median(age),
            sd_age=sd(age)) %>% 
  t()
```

We have no missing data in our 2019-2023 panel.

```{r}
panel_19_23 %>% 
  vis_miss()
  
```


Try to create age groups and see the distribution by political orientation.

```{r}
panel19_23_stacked %>% 
  mutate(age_group =case_when(age<25 ~ "18-24",
                              age<35 ~ "25-34",
                              age<45 ~ "35-44",
                              age<55 ~"45-54",
                              age<65 ~"55-64",
                              TRUE ~"65 and over")) %>% 
  group_by(age_group, right, survey_year) %>% 
  dplyr::summarise(count=n(),
                   mean_prop_vote=mean(propensity_to_vote),
                   median_prop_vote=median(propensity_to_vote))
```

We notice that the standard age groups of younger people are less well represented in our panel.


```{r}
panel19_23_stacked %>% 
  mutate(survey_year=as.factor(survey_year)) %>% 
  mutate(age_group =case_when(age<25 ~ "18-24",
                              age<35 ~ "25-34",
                              age<45 ~ "35-44",
                              age<55 ~"45-54",
                              age<65 ~"55-64",
                              TRUE ~"65 and over")) %>% 
  group_by(age_group, right) %>% 
  dplyr::summarise(count=n(),
                   mean_prop_vote=mean(propensity_to_vote),
                   median_prop_vote=median(propensity_to_vote)) %>% 
  ggplot(aes(x=age_group, y=count)) +
  geom_col() +
  labs(title="Stacked panel data 2019-2023 distribution by standard age groups")
```

So we will regroup data into 3 segments that are more equally represented across the panel.

```{r}
panel19_23_stacked %>% 
  mutate(survey_year=as.factor(survey_year)) %>% 
  mutate(age_group =case_when(age<45 ~ "18-44",
                              age<65 ~"45-64",
                              TRUE ~"65 and over")) %>% 
  group_by(age_group, right, survey_year) %>% 
  dplyr::summarise(count=n(),
                   mean_prop_vote=mean(propensity_to_vote),
                   median_prop_vote=median(propensity_to_vote)) %>% 
  ggplot(aes(x=age_group, y=count, fill=right)) +
  geom_col()+
  facet_wrap(vars(survey_year)) +
  labs(title="Distribution of age groups over time",
       subtitle="counts of individuals from the 2019-2023 panel",
       caption="LISS balanced panel data 2019-2023: 1658 individuals in total")
```

## Panel dataset that includes voters who swinged from left to right

We previously excluded from our panel any voter who swinged right-left or vice-versa at any point over the 5 years.

Now we are interested to keep any voters who swinged from left to right. But still remove the ones who swinged from right to left.

This is what we do with the code below. First we join together the 5 years such that we keep a balanced dataset (only individual present in the data for all 5 years are kept).

```{r}
# fixing some column names
data22_cleaned <- data22_cleaned %>% 
  dplyr:: rename(age.22=age, 
         propensity_to_vote.22=propensity_to_vote, 
         political_orientation.22=political_orientation, 
         survey_year.22=survey_year, 
         right.22=right)

data23_cleaned <- data23_cleaned %>% 
  dplyr:: rename(age.23=age, 
         propensity_to_vote.23=propensity_to_vote, 
         political_orientation.23=political_orientation, 
         survey_year.23=survey_year, 
         right.23=right)

```


```{r message=FALSE, warning=FALSE}
library(plyr)

panel_swing_19_23 <- join_all(list(data19_cleaned, data20_cleaned, data21_cleaned, data22_cleaned, data23_cleaned), 
         by='nomem_encr', type='inner') 

nrow(panel_swing_19_23)
```


We know we need to correct some 2019 values encoded as "999" for both propensity to vote and political orientation.

```{r}
panel_swing_19_23 <- panel_swing_19_23 %>% 
  mutate(propensity_to_vote.19= if_else(propensity_to_vote.19==999, true=propensity_to_vote.20, false=propensity_to_vote.19) ) # in 2019 prop to vote encoded at 999, use 2020 value (2 voters), they both had 100 prop to vote over the next 4 years
```


```{r}
panel_swing_19_23 <- panel_swing_19_23 %>% 
  mutate(political_orientation.19= if_else(political_orientation.19==999, true=political_orientation.20, false=political_orientation.19) ) %>% # if 2019 pol_orient encoded 999, use 2020 value
  mutate(right.19=case_when(political_orientation.19<=5 ~ 0, TRUE ~ 1)) %>% # recalculate right dummy
  mutate(right.19=as.factor(right.19)) # set it as a factor
```


Voters in our panel who did not swing at all over the entire period: 1658

```{r}
panel_swing_19_23 %>% 
  filter(right.23==right.22) %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) %>% 
  dim()
```



Voters who swang from left (0) to right (1) over the entire period: 566


```{r}
panel_swing_19_23 %>% 
  filter((right.19==0 & right.20==1) | (right.20==0 & right.21==1) | (right.21==0 & right.22==1) | (right.22==0 & right.23==1)) %>% 
  dim()
```


We can also check that among those who swang left to right, nobody retraced steps back to left.


```{r}
panel_swing_19_23 %>% 
  filter((right.19==0 & right.20==1) | (right.20==0 & right.21==1) | (right.21==0 & right.22==1) | (right.22==0 & right.23==1)) %>% 
  filter(! (right.19==1 & right.20==0) | ! (right.20==1 & right.21==0) | ! (right.21==1 & right.22==0) | ! (right.22==1 & right.23==0)) %>% 
  dim()
```


Voters who swang from right to left over the entire period: 563

```{r}
panel_swing_19_23 %>% 
  filter((right.19==1 & right.20==0) | (right.20==1 & right.21==0) | (right.21==1 & right.22==0) | (right.22==1 & right.23==0)) %>% 
  dim()
```


Building a balanced panel in which we keep only people who swang from left to right:
1658 who did not swing + 566 who swang left to right =   2224

```{r}

dplyr:: bind_rows(panel_swing_19_23 %>% 
  filter((right.19==0 & right.20==1) | 
           (right.20==0 & right.21==1) | 
           (right.21==0 & right.22==1) | 
           (right.22==0 & right.23==1)), # swingers left to right
  panel_swing_19_23 %>% 
  filter(right.23==right.22) %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) # non-swingers
  ) %>% 
  dim()
```


```{r}
panel_swing_19_23 <- dplyr:: bind_rows(panel_swing_19_23 %>% 
  filter((right.19==0 & right.20==1) | 
           (right.20==0 & right.21==1) | 
           (right.21==0 & right.22==1) | 
           (right.22==0 & right.23==1)), # swingers left to right
  panel_swing_19_23 %>% 
  filter(right.23==right.22) %>% 
  filter(right.22==right.21) %>% 
  filter(right.21==right.20) %>% 
  filter(right.20==right.19) # non-swingers
  )
```


Turn the data into a stacked tibble.

```{r message=FALSE, warning=FALSE}
panel_swing_stacked_19_23 <- panel_swing_19_23 %>% 
  mutate(right.19=as.numeric(right.19),
         right.20=as.numeric(right.20),
         right.21=as.numeric(right.21),
         right.22=as.numeric(right.22),
         right.23=as.numeric(right.23))%>% 
  pivot_longer(col=c(-nomem_encr), names_to="metrics", values_to = "values") %>% 
  mutate(year=str_sub(metrics, start=-2),
         metrics=str_remove(metrics, ".\\d\\d")) %>% 
  pivot_wider(names_from = metrics, values_from = values) %>% 
  select(-year) %>% 
  mutate(right=if_else(right==1, true=0, false=1)) %>% 
  mutate(right=as.factor(right))
```


Just checking some descriptive stats for the new panel:


```{r}
panel_swing_stacked_19_23 %>% 
  group_by(right, survey_year) %>% 
  dplyr:: summarise(counts=n(),
            mean_political_orientation = mean(political_orientation),
            median_political_orientation=median(political_orientation),
            sd_political_orientation=sd(political_orientation),
            mean_propensity_to_vote= mean(propensity_to_vote),
            median_propensity_to_vote= median(propensity_to_vote),
            sd_propensity_to_vote=sd(propensity_to_vote)) %>% 
  t()
```

Showing panel is balanced.

```{r}
panel_swing_stacked_19_23 %>% 
  group_by(survey_year) %>% 
  dplyr:: summarise(counts=n())
```



I'll export the datasets to a csv file for the analysis.

```{r}
#write.csv(panel_19_23, "panel_19_23.csv")
```


```{r}
#write.csv(panel19_23_stacked, "panel19_23_stacked.csv")
```


```{r}
#write.csv(panel_swing_stacked_19_23, "panel_swing_stacked_19_23.csv")
```


