---
title: "Difference in difference with LISS propensity to vote and political orientation and IV on Ukraine war"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read the data

We previously cleaned and joined the data in a csv balanced panel file. Here we simply read in that data.


```{r message=FALSE, warning=FALSE}
library(readr)
library(bacondecomp)
library(did)
library(eatATA)
library(haven)
library(lfe)
library(panelView)
library(tidyverse)
library(ivDiag)

panel19_24_stacked <- read_csv("panel19_24_stacked.csv")
```

Balanced panel, 6 years of data.

```{r}
panel19_24_stacked %>% 
  dplyr:: group_by(survey_year) %>% 
  dplyr:: summarise(count=n())
```

Every year about 849 individuals from our panel are left-leaning and 832 are right-leaning.


```{r}
panel19_24_stacked %>% 
  dplyr:: group_by(right) %>% 
  dplyr:: summarise(count=n()/5)
```

## Create treatment variable

In our case, we need to create a treatment variable - **treatment_23**- which takes value 1 when year=2023 or 2024 and the individual is left-leaning (i.e. right==0).

The effect of the crisis had not yet take center stage in 2022 at the time when the LISS data was collected (Dec 2021-Mar 2022), by waves depending on sections of the questionnaire, with the war commencing end of Feb 2022. Thus our instrument takes on value 1 when year=2023 or 2024 (not 2022) and the individual is left-leaning.



```{r}

panel19_24_stacked <- panel19_24_stacked %>% 
  mutate(treatment_23_left =if_else((right==0 & survey_year>=2023), true= 1, false=0))
```



```{r}
panel19_24_stacked %>% 
  head()
```

## Plotting the data

```{r}
panel19_24_stacked %>% 
  dplyr:: group_by(right, survey_year) %>% 
  dplyr:: summarise(mean_prop_to_vote= (mean(propensity_to_vote))) %>% 
  dplyr:: mutate(right=as.factor(right)) %>% 
  ggplot(aes(x=survey_year, y=mean_prop_to_vote, color=right))+
  geom_point()+
  geom_line()+
  labs(title="Mean propensity to vote by political orientation",
       subtitle = "1=right-leaning, 0=left-leaning, no swing",
       caption="LISS Panel data 2019-2024: 1402*6= 8412 observations")
```


```{r}
panel19_24_stacked %>% 
  mutate(right=as.factor(right)) %>% 
  ggplot(aes(x=propensity_to_vote, y=right, color=right)) +
  geom_point()+
  geom_boxplot() +
  coord_flip() +
  facet_wrap(vars(survey_year)) +
  labs(title="Distribution of propensity to vote by political orientation",
       x="propensity to vote (0 to 100)",
       y="")
```


## TSLS with IV=time of the Russia-Ukraine war for the left-leaning group

Now we estimate the first stage of our dif-in-dif model

```{r}
dd_reg <- felm(political_orientation ~ treatment_23_left | survey_year + nomem_encr, data=panel19_24_stacked)

summary(dd_reg)
```


We can see that it seems that the treatment coefficient is highly significant: the year 2023 increases (=turns to the right) the political orientation of left-leaning people by 0.08 points on the 0 to 10 scale. 

But for now let's store the main_ATT_1 and the confidence interval boundaries.

```{r}
main_ATT_1= summary(dd_reg)$coefficients["treatment_23_left", "Estimate"]

ATT_1_CI_lower_boundary = abs(main_ATT_1 - qnorm(0.975)*summary(dd_reg)$coefficients["treatment_23_left", "Std. Error"])

ATT_1_CI_upper_boundary = abs(main_ATT_1 + qnorm(0.975)*summary(dd_reg)$coefficients["treatment_23_left", "Std. Error"])
```


```{r}
c(main_ATT_1, ATT_1_CI_lower_boundary, ATT_1_CI_upper_boundary)
```


## Event study: check the parallel trends assumption

We have to run an event study to see if the parallel trends assumption holds and the estimators on lagged treatment are within the confidence interval.

```{r}
panel19_24_stacked <- panel19_24_stacked %>% 
  mutate(lag19=if_else((survey_year==2019 & right==0), true=1, false=0),
         lag20=if_else((survey_year==2020 & right==0), true=1, false=0),
         lag21=if_else((survey_year==2021 & right==0), true=1, false=0),
         lag22=if_else((survey_year==2022 & right==0), true=1, false=0),
         lead23=if_else((survey_year==2023 & right==0), true=1, false=0),
         lead24=if_else((survey_year==2024 & right==0), true=1, false=0))

```



```{r}
event_study_reg <- felm(propensity_to_vote ~ lag19 + lag20 + lag21 + lag22 + lead23  | survey_year + nomem_encr, data=panel19_24_stacked)
```


```{r}
summary(event_study_reg)
```



```{r}

plot_order <-c("lag19", "lag20", "lag21", "lag22", "lead23")

#Plotting results
leadslags_plot <- tibble(
  sd = summary(event_study_reg)$coefficients[, "Std. Error"],
  mean = coef(event_study_reg)[plot_order],
  label = plot_order
)

leadslags_plot

leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-qnorm(0.95)*sd,
             ymax = mean+qnorm(0.95)*sd)) +
  geom_hline(yintercept = ATT_1_CI_lower_boundary, color = "red") +
  geom_hline(yintercept = -ATT_1_CI_lower_boundary, color = "red") +
  geom_pointrange() +
  theme_minimal() +
  xlab("Years before the war") +
  ylab("Propensity to vote") +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  geom_vline(xintercept = 0,
             linetype = "dashed")
```

This plot shows that we have a violation of the parallel trends assumption.


For the second stage of our two-stage least-squares (TSLS) we need to store the predicted values of political orientation from the first stage model above (dd_reg). We'll store them in a new variable called pred_political_orientation.



```{r message=FALSE, warning=FALSE}
panel19_24_stacked <- panel19_24_stacked %>% 
  mutate(pred_political_orientation = as.tibble(fitted(dd_reg)) %>% 
  pull(political_orientation))

```


Just to get an idea of how predicted political_orientation and true political orientation compare, we'll make a scatterplot.

```{r}
panel19_24_stacked %>% 
  mutate(right=as.factor(right)) %>% 
  ggplot(aes(x=political_orientation, y=pred_political_orientation, color=right)) +
  geom_point() +
  facet_wrap(vars(survey_year)) +
  labs(title="Comparison between political orientation and predicted political orientation")
```


For the second stage, we regress the outcome (propensity to vote) on the predicted political orientation, with fixed effects.


```{r}
dd_reg_2 <- felm(propensity_to_vote ~ pred_political_orientation | survey_year + nomem_encr, data=panel19_24_stacked)

summary(dd_reg_2)
```


Our LATE estimand of -1.275 is highly insignificant. Had the coefficient been significant, this would mean that year 2023 reduced the propensity to vote of the left-leaning group.

We store the estimated value and confidence intervals.


```{r}
LATE= summary(dd_reg_2)$coefficients["pred_political_orientation", "Estimate"]

LATE_CI_lower_boundary = abs(LATE - qnorm(0.975)*summary(dd_reg_2)$coefficients["pred_political_orientation", "Std. Error"])

LATE_CI_upper_boundary = abs(LATE + qnorm(0.975)*summary(dd_reg_2)$coefficients["pred_political_orientation", "Std. Error"])

c(LATE, LATE_CI_lower_boundary, LATE_CI_upper_boundary)

```


## Standard OLS estimation 

We regress propensity to vote on political orientation, the treatment variable (=1 after the crisis, for left-leaning people) and the interaction term between treatment and political orientation.

Probably the relationship is endogenous, but just to be able to compare results.

```{r}
library(fixest)

ols_reg <- feols(
  propensity_to_vote ~ political_orientation, # Regression formula
  data=panel19_24_stacked,
  vcov = "hc1" #--variance-covariance ratio, hc=heterochedasticity-consistent
)

summary(ols_reg)
```

Here we obtain a negative and significant coefficient. Increasing political orientation by one unit = moving to the right is associated with 0.297 lower propensity to vote.

And a Hausman test, which is highly significant, so we should not use the OLS results.


```{r}
library(ivDiag)

eff_F(panel19_24_stacked, Y = "propensity_to_vote", D = "political_orientation", Z = "treatment_23_left")
```




```{r}
library(binsreg)

binscatter <- binsreg(panel19_24_stacked$propensity_to_vote, panel19_24_stacked$political_orientation)
binscatter$bins_plot +
  labs(y = "Propensity to vote", x = "Political orientation",
       title="The propensity to vote of people with moderate political views is lower")
```


## Simple TSLS, no fixed-effects:

```{r}
ddreg_tsls <- feols(
  propensity_to_vote ~ 1 | 0 | political_orientation ~ treatment_23_left, 
  data = panel19_24_stacked,
  vcov = "hc1"
)

ddreg_tsls
```

We reject the null hypothesis and conclude that heteroscedasticity is present.

```{r}
library(lmtest)

# Perform the Breusch-Pagan test
bp_test <- bptest(
  formula = propensity_to_vote ~ political_orientation , 
  data = panel19_24_stacked
)
print(bp_test)
```


Anderson-Rubin confidence set: F is pretty close to 10.

```{r}
ivres <-ivDiag(panel19_24_stacked, Y="propensity_to_vote", D="political_orientation", Z="treatment_23_left")

ivres$F_stat
ivres$AR
```




## TSLS with fixed effects 

Here we obtain the exact same results as above when implementing TSLS in two stages.


```{r}
feols(
  propensity_to_vote ~ 1 | survey_year + nomem_encr | political_orientation ~ treatment_23_left, 
  data = panel19_24_stacked,
  vcov = "hc1"
)
```


With the corresponding Anderson-Rubin test, which this time is highly insignificant and the interval contains 0.


```{r}
ivres_fe <- ivDiag(panel19_24_stacked, Y = "propensity_to_vote", D = "political_orientation", Z = "treatment_23_left", FE = c("survey_year","nomem_encr"))
ivres_fe$F_stat
ivres_fe$AR
```





## Panel with swingers (from left to right)

We redo the same exercise as above, but allowing for swingers from LEFT to RIGHT at any point during the 5 years.

```{r message=FALSE, warning=FALSE}
panel_swingers <- read_csv("panel_swing_stacked_19_24.csv")
```


```{r}
panel_swingers <- panel_swingers %>% 
  mutate(treatment_23_left =if_else((right==0 & survey_year>=2023), true= 1, false=0))
```


```{r}

panel_swingers %>% 
  dplyr:: group_by(right, survey_year) %>% 
  dplyr:: summarise(mean_prop_to_vote= (mean(propensity_to_vote))) %>% 
  dplyr:: mutate(right=as.factor(right)) %>% 
  ggplot(aes(x=survey_year, y=mean_prop_to_vote, color=right))+
  geom_point()+
  geom_line()+
  labs(title="Mean propensity to vote by political orientation",
       subtitle = "1=right-leaning, 0=left-leaning, with LEFT to RIGHT swing",
       caption="LISS Panel data 2019-2023: 2013 *6 = 12'078 observations")
```

TSLS with fixed effects

```{r}
feols(
  propensity_to_vote ~ 1 | survey_year + nomem_encr | political_orientation ~ treatment_23_left, 
  data = panel_swingers,
  vcov = "hc1"
)
```


The estimated coefficient is still insignificant, but this time it is positive.

Below we perform the Anderson-Rubin test, including fixed-effects this time.


```{r}
ivDiag(panel_swingers, Y = "propensity_to_vote", D = "political_orientation", Z = "treatment_23_left", FE = c("survey_year","nomem_encr"))
```


## Panel with swingers and using "age" as a covariate (conditional parallel trends)

We can add age because did not change with the Ukraine-Russian war, but we will model it as a quadratic function.

```{r}
feols(
  propensity_to_vote ~ 1 + age | survey_year + nomem_encr | political_orientation ~ treatment_23_left + age, 
  data = panel_swingers,
  vcov = "hc1"
)
```


Now let's try with a quadratic age control.



```{r}
feols(
  propensity_to_vote ~ 1 + age^2 | survey_year + nomem_encr | political_orientation ~ treatment_23_left + age^2, 
  data = panel_swingers,
  vcov = "hc1"
)
```

